.. _continuous_dep:

Continuous deployment
#####################

You can enable continuous synchronization of your deployment with the source repository.

.. note::

   It is optional to keep the deployment in your account in synchronization with the source code repository automatically.

For the continuous deployment to work, you need to fork the source code in order to register the webhook listener that triggers an upgrade of your deployment.

After forking, make sure to update the ``repository.url`` in the :file:`package.json` file in your fork.

This sets up an AWS CodePipeline, which triggers a CodeBuild project for every push to the :file:`saga` branch.
You can configure the branch in the ``deploy.branch`` property of the :file:`package.json` file.
The CodeBuild project upgrades the CloudFormation stack, which contains the *Bifravst* resources.

A second CodePipeline will be set up for the web app, which triggers a CodeBuild project for every push to the :file:`saga` branch.
You can configure the repository URL and the branch for the web app in the ``deploy.webApp`` property of the :file:`package.json` file.
The CodeBuild project upgrades the web app deployment on the S3 bucket.

Provide GitHub credentials
**************************

You need to create a `developer token <https://help.github.com/en/articles/creating-a-personal-access-token-for-the-command-line>`_ with ``repo``, ``admin:repo_hook`` and ``read:packages`` permissions for an account that has write permissions to your repository.

.. note::

   It is recommended to use a separate GitHub account instead of your personal GitHub account.

You need to store this token in `AWS ParameterStore <https://docs.aws.amazon.com/systems-manager/latest/userguide/systems-manager-parameter-store.html>`_ and it is a *one-time* manual step done through AWS CLI using the following command:

.. code-block:: bash

    aws ssm put-parameter --name /codebuild/github-token \
        --type String --value "<Github Token>"

Enable Continuous Deployment
****************************

After providing the GitHub credentials, you can set up the continuous deployment using the following command:

.. code-block:: bash

    npx cdk deploy '*' -c cd=1

Check the status of the Continuous Deployment
*********************************************

If you want to check the status of the continuous deployment after you have made the changes, you can use the following CLI command:

.. code-block:: bash

    node cli cd

Below is a sample output generated by the above command:

.. figure:: ./cli-cd.png
   :alt: Output of node cli cd

   Output of node cli cd
